<!-- TODO:
 * Ensure units are imperial (feet, inches) for all measurements
   - Implement conversion functions where necessary
   - Consider a project level setting for unit preference
 * Add GPS collection for plots
  - Implement point averaging for accuracy
  - Capture basic satellite data (e.g., number of satellites, HDOP)
  - Estimate error radius based on HDOP
  - Store in a plot_gps table with plot Id reference
  - Display real-time distance from planned plot location
 * Implement a map view with plot locations
  - Use Leaflet or similar library for map rendering
  - Use turf.js for geospatial calculations
  - Allow users to select plots on the map
  - Show plot details on click
  - Display GPS position on map
  - Display tree locations on map
 * Implement tree data entry form with validation
 * Add project and plot summary views
   - Basal area, density, volume calculations
   - Sampling error estimates
   - Species summaries
 * Add option to merge projects
 * Modify project name to be unique on import
 * Implement a settings page for user preferences
 * Add a help section with FAQs and contact info
 * Implement a dark mode toggle
 * Add design codes at the project level
 * Add a merchandizing rules table
   - The rules will be assigned by id in the species table and is thus region specific
 * Add species table
    - Species list should be a table with a region field
    - Species region should be selectable at the project level
    - Defaults for form factor, taper coefficients, specific gravity, bark thickness
 * Add a log segmentation form
    - Automate log segmentation based on species merchandizing rules
      + Allow for resegmentation of logs, say for example, when a cull log is added
    - Include defect codes for length, diameter, percent
    - Compute gross and net volumes for logs, cubic and scribner
    - Include inside bark diameter for logs
 * Capture cruiser info in a table
   - Add a plot_cruiser table to track who cruised each plot
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forest Inventory PWA</title>
  <link rel="icon" href="https://placehold.co/192x192/25635b/31363f?text=FIx" type="image/png">

  <!-- Web App Manifest -->
  <meta name="theme-color" content="#25635b">
  <link rel="manifest" href="/mobile_cruise/manifest.webmanifest">

  <!-- PrimeIcons CSS -->
  <link rel="stylesheet" href="https://unpkg.com/primeicons@6.0.1/primeicons.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/iconoir-icons/iconoir@main/css/iconoir.css" />

  <!-- Tailwind CSS -->
  <!-- <script src="https://cdn.tailwindcss.com"></script> -->

  <!-- Local compiled Tailwind CSS-->
  <link rel="stylesheet" href="/mobile_cruise/css/tailwind.css">

</head>
<body class="bg-gray-100 text-gray-800">

  <div id="app" class="max-w-7xl mx-auto p-0">
    <!-- Vue app will be mounted here -->
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/vue-router@4"></script>

  <!-- Dexie.js for IndexedDB -->
  <script src="https://unpkg.com/dexie@3/dist/dexie.min.js"></script>

  <script type="module">
    // Destructure Vue and Vue Router modules, including provide and inject
    const { createApp, ref, reactive, onMounted, onUnmounted, computed, watch, nextTick, provide, inject } = Vue;
    const { createRouter, createWebHashHistory, useRoute, useRouter } = VueRouter;

    // --- DATABASE SETUP (Dexie.js) ---
    const db = new Dexie('ForestInventoryDB');
    db.version(1).stores({
      projects: 'id, name', // Primary key 'id' (UUID), indexed 'name'
      plots: 'id, projectId, plotNumber', // Primary key 'id' (UUID), indexed 'projectId' and 'plotNumber'
      trees: 'id, plotId, treeNumber', // Primary key 'id' (UUID), indexed 'plotId' and 'treeNumber'
    });

    const app_version = '0.0.1'; // Current app version
    // --- MOCK USER (for tracking updates) ---
    const currentUser = { username: 'field_user_01' };
    const design_code_list = ['B1', 'F1', 'S1', 'B2', 'F2', 'S2']; // Sample codes for trees
    const species_list = ['DF', 'WH', 'RA', 'BM', 'NF']; // Example species list
    const status_list = ['Live', 'Dead', 'Cut']; // Example status list
    // const crown_ratio_list = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]; // Crown ratio percentages
    const crown_ratio_list = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100]; // Crown ratio percentages
    const bole_diam_codes = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split(""); // Top diameter codes
    const crown_position_list = ['OVR', 'DOM', 'COD', 'INT', 'SUP', 'UDS']; // Crown position options
    const vigor_list = ['H', 'M', 'L', 'D','']; // Vigor options
    const damage_list = ['','Animal', 'Mechanical', 'Fire', 'Disease', 'Insect']; // Damage options

    // Utility function for UUID (uses browser's crypto API)
    function uuid() {
      return (crypto.randomUUID ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      ));
    }

    // --- COMPONENT: About ---
    // Displays information about the app and its features.
    const About = {
      props: ['app_version', 'cache_version'],
      emits: ['close'],
      template: `
        <div class="modal-container" @click.self="$emit('close')">
          <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="modal-panel w-full max-w-sm">
              <div class="p-6">

                <h1 class="text-2xl font-bold mb-4">About Forest Inventory PWA</h1>
                <p class="text-gray-700 mb-4">This Progressive Web App (PWA) is designed for field crews to collect and manage forest inventory data efficiently.</p>
                <h2 class="text-xl font-semibold mb-2">Features:</h2>
                <ul class="list-disc pl-5 text-gray-700">
                  <li>Offline data collection</li>
                  <li>Data export/import</li>
                  <li>Responsive design for mobile devices</li>
                </ul>
                <p class="mt-4 text-gray-500">Developed by the Forest Inventory Team.</p>

                <p class="mt-4 text-gray-500">App version: {{ app_version }}</p>
                <p class="mt-4 text-gray-500">Cache version: {{ cache_version }}</p>

                <div class="mt-4">
                  <button type="button" @click="$emit('close')" class="btn btn-primary">OK</button>
                </div>

              </div>
            </div>
          </div>
        </div>
      `
    };

    // --- COMPONENT: Alert Modal ---
    // A simple modal for displaying alerts to the user.
    const AlertModal = {
      props: ['title', 'message'], // Props for title and message
      emits: ['close'], // Emits a 'close' event when the modal is dismissed
      template: `
        <div class="modal-container" @click.self="$emit('close')">
          <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="modal-panel w-full max-w-sm">
              <div class="p-6 text-center">
                <h3 class="text-lg font-semibold text-gray-900">{{ title }}</h3>
                <p class="mt-2 text-sm text-gray-500">{{ message }}</p>
                <div class="mt-4">
                  <button type="button" @click="$emit('close')" class="btn btn-primary">OK</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `
    };

    // --- COMPONENT: Confirmation Modal ---
    // A modal for getting user confirmation for critical actions.
    const ConfirmationModal = {
      props: ['title', 'message'], // Props for title and message
      emits: ['confirm', 'cancel'], // Emits 'confirm' or 'cancel' based on user action
      template: `
        <div class="modal-container" @click.self="$emit('cancel')">
          <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div class="modal-panel w-full max-w-md">
              <div class="p-6">
                <div class="sm:flex sm:items-start">
                  <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <!-- PrimeIcon for alert/warning -->
                    <i class="pi pi-exclamation-triangle h-6 w-6 text-red-600" aria-hidden="true"></i>
                  </div>
                  <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                    <h3 class="text-lg font-semibold leading-6 text-gray-900">{{ title }}</h3>
                    <div class="mt-2"><p class="text-sm text-gray-500">{{ message }}</p></div>
                  </div>
                </div>
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                  <button type="button" @click="$emit('confirm')" class="btn btn-danger w-full sm:ml-3 sm:w-auto">Confirm</button>
                  <button type="button" @click="$emit('cancel')" class="btn btn-secondary mt-3 w-full sm:mt-0 sm:w-auto">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,
      setup() {
        return {}; // No specific state or methods needed for this simple component
      }
    };

    // --- NavBar Component (Updated with correct absolute positioning) ---
    const NavBar = {
      props: ['breadcrumbs'],
      emits: ['import', 'about'],
      template: `
        <div class="relative">
          <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-2 py-1 flex items-center justify-between">
              <!-- Breadcrumbs -->
              <div class="flex items-center space-x-2">
                <template v-for="(crumb, idx) in breadcrumbs || []" :key="idx">
                  <router-link
                    v-if="crumb && crumb.to"
                    :to="crumb.to"
                    class="text-teal-700 hover:underline font-medium"
                  >{{ crumb.label }}</router-link>
                  <span v-else-if="crumb" class="text-gray-500">{{ crumb.label }}</span>
                  <span v-if="idx < (breadcrumbs?.length || 0) - 1" class="mx-1 text-gray-400">/</span>
                </template>
              </div>
              <!-- Hamburger Button and Dropdown Container -->
              <div class="relative">
                <button @click="menuOpen = !menuOpen" class="inline-flex items-center justify-center p-2 rounded-md text-teal-700 hover:bg-gray-100">
                  <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
                  </svg>
                </button>

                <!-- Hamburger Menu Dropdown (absolutely positioned) -->
                <div v-if="menuOpen" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                  <div class="py-1">
                    <label for="import-json-navbar" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                      <i class="pi pi-upload mr-2"></i> Import Project
                    </label>
                    <input id="import-json-navbar" type="file" @change="$emit('import', $event)" class="hidden" accept=".json">
                    <button class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" disabled>
                      <i class="pi pi-wrench mr-2"></i> Tools (coming soon)
                    </button>
                    <button class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" disabled>
                      <i class="pi pi-cog mr-2"></i> Setup (coming soon)
                    </button>
                    <button type="button" @click="$emit('about'); menuOpen = false" class="w-full text-left flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                      <i class="pi pi-info-circle mr-2"></i> About
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </nav>
        </div>
      `,
      data() {
        return { menuOpen: false };
      },
      mounted() {
        document.addEventListener('click', this.closeMenuOnClickOutside);
      },
      beforeUnmount() {
        document.removeEventListener('click', this.closeMenuOnClickOutside);
      },
      methods: {
        closeMenuOnClickOutside(event) {
          if (this.menuOpen && !this.$el.contains(event.target)) {
            this.menuOpen = false;
          }
        }
      }
    };

    // --- COMPONENT: Home / Project Summary ---
    // Displays a list of projects, allows creating new projects, and importing/exporting.
    const Home = {
      components: { AlertModal, NavBar },
      template: `
        <div>
          <NavBar :breadcrumbs="breadcrumbs" @import="importProject" @about="showAbout"/>
          <div class="space-y-6 mt-4">
            <!-- Alert Modal display -->
            <AlertModal v-if="alertInfo.show" :title="alertInfo.title" :message="alertInfo.message" @close="alertInfo.show = false" />

            <!-- Existing Projects List -->
            <div>
              <h2 class="text-xl font-semibold mb-2">Existing Projects</h2>
              <div v-if="projects.length === 0" class="text-center text-gray-500 py-8">No projects found. Create one to get started!</div>
              <div v-else class="grid grid-cols-1">
                <div v-for="project in projects" :key="project.id" class="card mb-2 hover:bg-lime-50 transition-colors">
                  <div class="flex-grow">
                  <h3 class="text-lg font-bold text-teal-700">{{ project.name }}</h3>
                  <p class="text-sm text-gray-500">ID: {{ project.id }}</p>
                  <p class="text-sm text-gray-500">Created: {{ new Date(project.createdAt).toLocaleString() }}</p>
                  <p class="text-sm text-gray-500">Plots: {{ project.plotCount || 0 }}</p>
                  </div>
                  <div class="mt-4 flex flex-wrap gap-2">
                  <router-link :to="'/project/' + project.id + '/plots'" class="btn btn-primary text-sm flex-grow">
                    <i class="pi pi-eye h-4 w-4 mr-2"></i> View Plots
                  </router-link>
                  <button @click="exportProject(project.id)" class="btn btn-secondary text-sm flex-grow">
                    <i class="pi pi-download h-4 w-4 mr-2"></i> Export
                  </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Create New Project Section -->
            <div class="bg-white p-2">
              <h2 class="text-xl font-semibold mb-2">Create New Project</h2>
              <form @submit.prevent="addProject" class="flex flex-col sm:flex-row gap-2">
                <input v-model="newProjectName" type="text" placeholder="Enter project name" class="input-field flex-grow" required>
                <button type="submit" class="btn btn-primary">
                  <i class="pi pi-plus h-5 w-5 mr-2"></i> Create Project
                </button>
              </form>
            </div>

          </div>
        </div>
      `,
      setup() {
        const projects = ref([]); // Reactive reference for storing projects
        const newProjectName = ref(''); // Reactive reference for new project input
        const alertInfo = reactive({ show: false, title: '', message: '' }); // Reactive object for alert modal state

        // Inject the globally provided showAbout function
        const showAbout = inject('showAbout');

        // Function to show the alert modal
        function showAlert(title, message) {
          alertInfo.title = title;
          alertInfo.message = message;
          alertInfo.show = true;
        }

        // Function to load projects from IndexedDB and count associated plots
        async function loadProjects() {
          const allProjects = await db.projects.toArray();
          for (const proj of allProjects) {
            proj.plotCount = await db.plots.where('projectId').equals(proj.id).count();
          }
          projects.value = allProjects;
        }

        // Load projects when the component is mounted
        onMounted(loadProjects);

        // Function to add a new project to IndexedDB
        async function addProject() {
          if (!newProjectName.value.trim()) return;
          await db.projects.add({
            id: uuid(),
            name: newProjectName.value,
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            updatedBy: currentUser.username
          });
          newProjectName.value = ''; // Clear input field
          await loadProjects(); // Reload projects to update the list
        }

        // Function to export a project and its associated data as a JSON file
        async function exportProject(projectId) {
          const project = await db.projects.get(projectId);
          const plots = await db.plots.where('projectId').equals(projectId).toArray();
          const trees = await db.trees.where('plotId').anyOf(plots.map(p => p.id)).toArray(); // Get trees for all plots in the project

          const exportData = { project, plots, trees };
          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${project.name.replace(/\s+/g, '_')}_export.json`; // Create a downloadable file name
          a.click();
          URL.revokeObjectURL(url); // Clean up the URL object
        }

        // Function to import a project from a JSON file
        function importProject(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (!data.project || !data.plots || !data.trees) {
                showAlert('Import Error', 'Invalid project file format.');
                return;
              }

              await db.transaction('rw', db.projects, db.plots, db.trees, async () => {
                // Add new project with new UUID
                const oldProjectId = data.project.id;
                data.project.id = uuid();
                const newProjectId = data.project.id;
                await db.projects.add(data.project);

                // Map old plot IDs to new UUIDs
                const plotIdMap = {};
                for (const plot of data.plots) {
                  const oldPlotId = plot.id;
                  plot.id = uuid();
                  plot.projectId = newProjectId;
                  plotIdMap[oldPlotId] = plot.id;
                  await db.plots.add(plot);
                }

                // Add trees with new UUIDs and updated plotId
                for (const tree of data.trees) {
                  tree.id = uuid();
                  tree.plotId = plotIdMap[tree.plotId];
                }
                if (data.trees.length > 0) {
                  await db.trees.bulkAdd(data.trees);
                }
              });
              showAlert('Success', 'Project imported successfully!');
              await loadProjects(); // Reload projects after successful import
            } catch (error) {
              console.error('Import failed:', error);
              showAlert('Import Failed', 'Could not import project. Check console for details.');
            }
          };
          reader.readAsText(file); // Read the file as text
          event.target.value = ''; // Clear the file input
        }

        // Breadcrumbs for Home
        const breadcrumbs = [
          { label: 'Projects', to: '/' }
        ];

        return { projects, newProjectName, addProject, exportProject, importProject, alertInfo, breadcrumbs, showAbout };
      }
    };

    // --- COMPONENT: PlotList ---
    // Displays a list of plots for a specific project, allows adding/deleting plots, and updating plot details.
    const PlotList = {
      components: { ConfirmationModal, NavBar },
      template: `
        <div>
          <NavBar :breadcrumbs="breadcrumbs" @import="importProject" @about="showAbout"/>
          <div class="mt-2">
            <!-- Confirmation Modal display -->
            <ConfirmationModal v-if="confirmInfo.show" title="Delete Plot" message="Are you sure you want to delete this plot and all its associated trees? This action cannot be undone." @confirm="handleDeleteConfirm" @cancel="confirmInfo.show = false"/>

            <!-- Survey Plots List -->
            <div>
              <h2 class="text-xl font-semibold mb-2">Survey Plots</h2>
              <div v-if="plots.length === 0" class="text-center text-gray-500 py-8">No plots found for this project. Add one to begin.</div>
              <div v-else class="grid grid-cols-1">
                <div v-for="plot in plots" :key="plot.id" class="card mb-2 hover:bg-lime-50 transition-colors">
                  <h3 class="text-lg font-bold text-teal-700">Plot #{{ plot.plotNumber }}</h3>
                  <div class="mt-2 grid grid-cols-2 sm:grid-cols-7 gap-2">
                    <div>
                      <label class="block text-xs font-medium text-gray-500">Slope (%)</label>
                      <input v-model.number="plot.slope" min="0" @change="updatePlot(plot)" type="number" class="input-field bg-white text-sm p-1 w-20">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-500">Aspect (°)</label>
                      <input v-model.number="plot.aspect" min="0" max="360" @change="updatePlot(plot)" type="number" class="input-field text-sm p-1 w-20">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-500">Elevation (ft)</label>
                      <input v-model.number="plot.elevation" @change="updatePlot(plot)" type="number" class="input-field text-sm p-1 w-20">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-500">Latitude</label>
                      <input v-model.number="plot.planned_latitude" @change="updatePlot(plot)" type="number" class="input-field text-sm p-1 w-20">
                    </div>
                    <div>
                      <label class="block text-xs font-medium text-gray-500">Longitude</label>
                      <input v-model.number="plot.planned_longitude" @change="updatePlot(plot)" type="number" class="input-field text-sm p-1 w-20">
                    </div>
                    <div class="col-span-full">
                      <label class="block text-xs font-medium text-gray-500 p-1">Notes</label>
                      <textarea v-model="plot.notes" placeholder="Any additional notes..." class="input-field w-full" rows="1"></textarea>
                    </div>

                  </div>
                  <p class="text-sm text-gray-500 mt-2">Trees Recorded: {{ plot.treeCount || 0 }}</p>
                  <p class="text-sm text-gray-500">Last Updated: {{ new Date(plot.lastUpdated).toLocaleString() }}</p>
                  <div class="mt-4 flex gap-2">
                    <router-link :to="'/plot/' + plot.id" class="btn btn-primary text-sm flex-grow">
                      <i class="pi pi-list h-4 w-4 mr-2"></i> Enter Tree Data
                    </router-link>
                    <button @click="deletePlot(plot.id)" class="btn btn-danger text-sm">
                      <i class="pi pi-trash h-4 w-4"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add New Plot Section -->
            <!-- TODO: Use the plot edit form -->
            <div class="bg-white p-2 mt-2">
              <h2 class="text-xl font-semibold mb-2">Add New Plot</h2>
              <form @submit.prevent="addPlot" class="flex flex-col sm:flex-row gap-2">
                <input v-model.number="newPlotNumber" type="number" min="0" placeholder="Enter plot number" class="input-field flex-grow" required>
                <button type="submit" class="btn btn-primary">
                  <i class="pi pi-plus h-5 w-5 mr-2"></i> Add
                </button>
              </form>
            </div>
          </div>
        </div>
      `,
      setup() {
        const route = useRoute(); // Access current route information
        const router = useRouter(); // Access router instance
        const projectId = route.params.projectId; // Get projectId from route params
        const project = ref({}); // Reactive reference for the current project
        const plots = ref([]); // Reactive reference for plots in the project
        const newPlotNumber = ref(null); // Reactive reference for new plot number input
        const confirmInfo = reactive({ show: false, plotId: null }); // Reactive object for confirmation modal state

        // Inject the globally provided showAbout function
        const showAbout = inject('showAbout');

        // Function to load project and its plots from IndexedDB
        async function loadData() {
          const proj = await db.projects.get(projectId);
          if (!proj) {
            router.push('/'); // Redirect to home if project not found
            return;
          }
          project.value = proj;
          const allPlots = await db.plots.where('projectId').equals(projectId).sortBy('plotNumber');
          // Count trees for each plot
          for (const plot of allPlots) {
            plot.treeCount = await db.trees.where('plotId').equals(plot.id).count();
          }
          plots.value = allPlots;
        }

        // Load data when the component is mounted
        onMounted(loadData);

        // Function to add a new plot to IndexedDB
        async function addPlot() {
          if (newPlotNumber.value === null) return; // Prevent adding empty plot number
          await db.plots.add({
            id: uuid(),
            projectId: projectId,
            plotNumber: newPlotNumber.value,
            slope: 0,
            aspect: 0,
            elevation: 0,
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            updatedBy: currentUser.username,
          });
          newPlotNumber.value = null; // Clear input field
          await loadData(); // Reload data to update the list
        }

        // Function to initiate plot deletion confirmation
        function deletePlot(plotId) {
          confirmInfo.plotId = plotId;
          confirmInfo.show = true;
        }

        // Function to handle plot deletion after confirmation
        async function handleDeleteConfirm() {
          await db.transaction('rw', db.plots, db.trees, async () => {
            await db.trees.where('plotId').equals(confirmInfo.plotId).delete(); // Delete associated trees
            await db.plots.delete(confirmInfo.plotId); // Delete the plot
          });
          confirmInfo.show = false; // Hide confirmation modal
          confirmInfo.plotId = null; // Clear plotId
          await loadData(); // Reload data to update the list
        }

        // Function to update plot details in IndexedDB
        async function updatePlot(plot) {
          const { id, slope, aspect, elevation, planned_latitude, planned_longitude } = plot;
          await db.plots.update(id, {
            slope,
            aspect,
            elevation,
            planned_latitude,
            planned_longitude,
            lastUpdated: new Date().toISOString(),
            updatedBy: currentUser.username
          });
          await loadData(); // Reload to refresh timestamp and tree counts
        }

        // Breadcrumbs for PlotList
        const breadcrumbs = computed(() => [
          { label: 'Projects', to: '/' },
          { label: project.value.name || 'Project', to: `/project/${projectId}/plots` }
        ]);

        function importProject(e) {
          // This is a placeholder. You might want to implement project import on this page as well.
          console.log("Import triggered on PlotList page.");
        }

        return { project, plots, newPlotNumber, addPlot, deletePlot, confirmInfo, handleDeleteConfirm, updatePlot, breadcrumbs, importProject, showAbout };
      }
    };

    // --- COMPONENT: Tree Edit Form (Embedded) ---
    // A form for editing individual tree details. Used within PlotObservation.
    const TreeEditForm = {
      props: [
        'tree', 'design_code_list', 'status_list', 'species_list',
        'bole_diam_codes','crown_position_list','crown_ratio_list',
        'vigor_list','damage_list'
      ],
      emits: ['save', 'cancel', 'delete'],
      template: `
        <div class="bg-lime-100 p-2 relative">
          <!-- Menu container -->
          <div ref="menuElement" class="absolute top-2 right-2 z-10">
              <button @click.stop="toggleMenu" type="button" class="p-2 rounded-full hover:bg-lime-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                  <i class="pi pi-ellipsis-v"></i>
              </button>
              <!-- Dropdown menu -->
              <div v-if="isMenuOpen" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                  <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                      <button @click="deleteTree" type="button" class="w-full text-left flex items-center px-4 py-2 text-sm text-red-700 hover:bg-gray-100" role="menuitem">
                          <i class="pi pi-trash mr-2"></i> Delete Tree
                      </button>
                  </div>
              </div>
          </div>

          <!--Update tree-->
          <form @submit.prevent="saveTree" class="space-y-2 mr-6">
            <div class="grid grid-cols-3 md:grid-cols-7 lg:grid-cols-11 gap-2 items-end mt-0">
              <div>
                <label class="block text-sm font-medium text-gray-700">Plot Code</label>
                <select v-model="localTree.design_code" class="input-field w-20" required>
                  <option v-for="code in design_code_list" :key="code" :value="code">{{ code }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Species</label>
                <select v-model="localTree.species" class="input-field w-20" required>
                  <option v-for="species in species_list" :key="species" :value="species">{{ species }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Status</label>
                <select v-model="localTree.status" class="input-field w-20">
                  <option v-for="status in status_list" :key="status" :value="status">{{ status }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Count</label>
                <input v-model.number="localTree.count" type="number" step="1.0" placeholder="e.g., 1" class="input-field w-20" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">DBH (in)</label>
                <input v-model.number="localTree.diameter" type="number" step="0.1" placeholder="e.g., 45.2" class="input-field w-20" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Form Point</label>
                <input v-model.number="localTree.form_point" type="number" step="0.1" placeholder="e.g., 4.5" class="input-field w-20" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Form Factor</label>
                <input v-model.number="localTree.form_factor" type="number" step="0.1" placeholder="e.g., 85.2" class="input-field w-20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Bole Diam</label>
                <select v-model="localTree.bole_diam" class="input-field w-20">
                  <option v-for="code in bole_diam_codes" :key="code" :value="code">{{ code }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Bole Ht.</label>
                <input v-model.number="localTree.bole_height" type="number" step="0.1" placeholder="e.g., 99" class="input-field w-20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Total Ht.</label>
                <input v-model.number="localTree.total_height" type="number" step="0.1" placeholder="e.g., 120.5" class="input-field w-20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Age</label>
                <input v-model.number="localTree.bh_age" type="number" step="1.0" placeholder="e.g., 42" class="input-field w-20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Crown Pos.</label>
                <select v-model="localTree.crown_position" class="input-field w-20">
                  <option v-for="code in crown_position_list" :key="code" :value="code">{{ code }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Crown Ratio</label>
                <select v-model="localTree.crown_ratio" class="input-field w-20">
                    <option v-for="val in crown_ratio_list" :key="val" :value="val">{{ val }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Vigor</label>
                <select v-model="localTree.vigor" class="input-field w-20">
                  <option v-for="code in vigor_list" :key="code" :value="code">{{ code }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Damage</label>
                <select v-model="localTree.damage" class="input-field w-20">
                  <option v-for="code in damage_list" :key="code" :value="code">{{ code }}</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Azimuth (°)</label>
                <input v-model.number="localTree.azimuth" type="number" step="0.1" class="input-field w-20">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Distance (ft)</label>
                <input v-model.number="localTree.distance" type="number" step="0.1" class="input-field w-20">
              </div>
            </div>
            <div class="col-span-full mt-4">
              <label class="block text-sm font-medium text-gray-700">Notes</label>
              <textarea v-model="localTree.notes" placeholder="Any additional notes..." class="input-field w-full" rows="1"></textarea>
            </div>
            <div class="pt-2 flex justify-end">
              <button type="submit" class="btn btn-primary">
                <i class="pi pi-save h-5 w-5 mr-2"></i> Update
              </button>
            </div>
          </form>
        </div>
      `,
      setup(props, { emit }) {
        const localTree = reactive({ ...props.tree });
        const isMenuOpen = ref(false);
        const menuElement = ref(null);

        function saveTree() {
          emit('save', { ...localTree });
        }

        function toggleMenu() {
          isMenuOpen.value = !isMenuOpen.value;
        }

        function deleteTree() {
          emit('delete', props.tree.id);
          isMenuOpen.value = false;
        }

        const handleClickOutside = (event) => {
          if (menuElement.value && !menuElement.value.contains(event.target)) {
            isMenuOpen.value = false;
          }
        };

        watch(isMenuOpen, (isOpen) => {
          if (isOpen) {
            document.addEventListener('click', handleClickOutside, true);
          } else {
            document.removeEventListener('click', handleClickOutside, true);
          }
        });

        onUnmounted(() => {
          document.removeEventListener('click', handleClickOutside, true);
        });

        watch(() => props.tree, (newTree) => {
          Object.assign(localTree, newTree);
        }, { deep: true, immediate: true });

        return { localTree, saveTree, isMenuOpen, toggleMenu, deleteTree, menuElement };
      }
    };

    // --- TreeTable Component ---
    // A compact table for creating, updating, and deleting tree records.
    const TreeTable = {
      props: [
        'trees', 'design_code_list', 'status_list', 'species_list',
        'bole_diam_codes','crown_position_list','crown_ratio_list',
        'vigor_list','damage_list'
      ],
      emits: ['create-tree', 'update-tree', 'delete-tree'],
      template: `
        <div class="bg-white p-1 overflow-x-auto">
          <!--<h2 class="text-xl font-semibold mb-2">Tree Table</h2>-->
          <table class="border-collapse table-auto min-w-full"
          @keyup.esc="cancelEditing">
            <thead class="text-center text-xs uppercase font-medium text-slate-500">
              <tr>
                  <th class="w-8">TR</th>
                  <th class="w-10">PF</th>
                  <th class="w-12">Sp</th>
                  <th class="w-14">Stat</th>
                  <th class="w-14">DBH</th>
                  <th class="w-8">FP</th>
                  <th class="w-8">FF</th>
                  <th class="w-10">BD</th>
                  <th class="w-10">BHT</th>
                  <th class="w-10">THT</th>
                  <th class="w-10">Age</th>
                  <th class="w-12">CP</th>
                  <th class="w-10">CR</th>
                  <th class="w-10">Vig</th>
                  <th class="w-14">Dmg</th>
                  <th class="w-10">Az</th>
                  <th class="w-10">Dist</th>
                  <th class="text-left w-30">Notes</th>
                  <th class="w-14">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white text-sm">
              <tr v-for="tree in localTrees" :key="tree.id" @click="startEditing(tree)"
                class="hover:bg-lime-100 cursor-pointer py-0"
                :class="getRowClass(tree)">
                  <td class="compact-td text-center min-w-6">{{ tree.treeNumber }}</td>
                  <td class="compact-td text-center min-w-10">
                      <div v-if="!isEditing(tree.id)" class="">{{ tree.design_code }}</div>
                      <select v-else v-model="editingTree.design_code" class="">
                          <option v-for="val in design_code_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-12">
                      <div v-if="!isEditing(tree.id)" class="table-field w-12">{{ tree.species }}</div>
                      <select v-else v-model="editingTree.species" class="table-field">
                          <option v-for="val in species_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-12">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.status }}</div>
                      <select v-else v-model="editingTree.status" class="table-field">
                          <option v-for="val in status_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.diameter }}</div>
                      <input v-else v-model.number="editingTree.diameter" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-8">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.form_point }}</div>
                      <input v-else v-model.number="editingTree.form_point" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-8">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.form_factor }}</div>
                      <input v-else v-model.number="editingTree.form_factor" type="number" class="table-field">
                  </td>
                  <td class="compact-td w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.bole_diam }}</div>
                      <select v-else v-model="editingTree.bole_diam" class="table-field">
                          <option v-for="val in bole_diam_codes" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-12">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.bole_height }}</div>
                      <input v-else v-model.number="editingTree.bole_height" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-12">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.total_height }}</div>
                      <input v-else v-model.number="editingTree.total_height" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.age }}</div>
                      <input v-else v-model.number="editingTree.age" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-14">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.crown_position }}</div>
                      <select v-else v-model="editingTree.crown_position" class="table-field">
                          <option v-for="val in crown_position_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.crown_ratio }}</div>
                      <select v-else v-model="editingTree.crown_ratio" class="table-field">
                          <option v-for="val in crown_ratio_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.vigor }}</div>
                      <select v-else v-model="editingTree.vigor" class="table-field">
                          <option v-for="val in vigor_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-14">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.damage }}</div>
                      <select v-else v-model="editingTree.damage" class="table-field">
                          <option v-for="val in damage_list" :key="val" :value="val">{{ val }}</option>
                      </select>
                  </td>
                  <td class="compact-td min-w-12">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.azimuth }}</div>
                      <input v-else v-model.number="editingTree.azimuth" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-10">
                      <div v-if="!isEditing(tree.id)" class="table-field">{{ tree.distance }}</div>
                      <input v-else v-model.number="editingTree.distance" type="number" class="table-field">
                  </td>
                  <td class="compact-td min-w-30 max-w-30">
                      <div v-if="!isEditing(tree.id)" class="table-text">{{ tree.notes }}</div>
                      <input v-else v-model="editingTree.notes" type="text" class="table-text">
                  </td>
                  <td class="compact-td font-medium">
                      <div v-if="isEditing(tree.id)" class="flex items-center space-x-2">
                          <button @click.stop="saveChanges" class="text-teal-600 hover:text-teal-900"><i class="pi pi-check"></i></button>
                          <button @click.stop="cancelEditing" class="text-gray-600 hover:text-gray-900"><i class="pi pi-times"></i></button>
                      </div>
                      <button v-else @click.stop="$emit('delete-tree', tree.id)" class="text-red-600 hover:text-red-900"><i class="pi pi-trash"></i></button>
                  </td>
              </tr>
            </tbody>
          </table>
          <div class="mt-4">
            <button @click="addNewTree" class="btn btn-primary"><i class="pi pi-plus mr-2"></i> Add New Tree</button>
          </div>
        </div>
      `,
      setup(props, { emit }) {
        const localTrees = ref([]);
        const editingTreeId = ref(null);
        const editingTree = reactive({});
        const autoSave = ref(true);

        watch(() => props.trees, (newTrees) => {
            localTrees.value = JSON.parse(JSON.stringify(newTrees)).sort((a,b) => a.treeNumber - b.treeNumber);
        }, { deep: true, immediate: true });

        // Watch the editingTree for changes
        watch(editingTree, (newItem, oldItem) => {

          if (!autoSave) { return }

          // localTrees.value.forEach(item => {
          //   if (item.id===newItem.id){
          //     Object.assign(item, newItem)
          //   }
          // })

          if (editingTree.id === 'new-tree-placeholder') {
              emit('create-tree', { ...editingTree });
          } else {
              emit('update-tree', { ...editingTree });
          }
        })

        const getRowClass = (tree) => {
          if (editingTree && tree.id===editingTree.id) {
            console.log('tr-active')
            return 'tr-active'
          } else {
            return 'tr-inactive'
          }

        }

        const isEditing = (treeId) => editingTreeId.value === treeId;

        const startEditing = (tree) => {
          // Skip if editing the same tree
          if (editingTree.id === tree.id){
            return;
          }

          if (editingTreeId.value) {
              // Optionally save previous edits before starting a new one
              // For simplicity, we'll just cancel previous
          }
          editingTreeId.value = tree.id;
          Object.assign(editingTree, tree);
        };

        const cancelEditing = () => {
            editingTreeId.value = null;
            Object.keys(editingTree).forEach(key => delete editingTree[key]);
        };

        const saveChanges = () => {
            if (editingTree.id === 'new-tree-placeholder') {
                emit('create-tree', { ...editingTree });
            } else {
                emit('update-tree', { ...editingTree });
            }
            cancelEditing();
        };

        const addNewTree = () => {
          // TODO: Use previous tree values as defaults
            const newTreeTemplate = {
                id: 'new-tree-placeholder',
                treeNumber: localTrees.value.length > 0 ? Math.max(...localTrees.value.map(t => t.treeNumber)) + 1 : 1,
                design_code: '',
                species: '',
                status: 'Live',
                diameter: null,
                azimuth: null,
                distance: null,
            };
            localTrees.value.push(newTreeTemplate);
            startEditing(newTreeTemplate);
        };

        return {
            localTrees,
            editingTreeId,
            editingTree,
            getRowClass,
            isEditing,
            startEditing,
            cancelEditing,
            saveChanges,
            addNewTree
        };
      }
    };


    // --- COMPONENT: Plot Observation ---
    // Displays details for a single plot, including a tree map and a list of recorded trees.
    // Allows adding trees visually or by azimuth/distance, and editing/deleting trees.
    const PlotObservation = {
      components: { TreeEditForm, ConfirmationModal, NavBar, TreeTable },
      template: `
        <div>
          <NavBar :breadcrumbs="breadcrumbs" @import="importProject" @about="showAbout"/>
          <div v-if="plot.id" class="mt-0">
            <!-- Confirmation Modal display -->
            <ConfirmationModal v-if="confirmInfo.show" title="Delete Tree" message="Are you sure you want to delete this tree? This action cannot be undone." @confirm="handleDeleteConfirm" @cancel="confirmInfo.show = false"/>

            <!-- Tabs for Tree Data Management -->
            <div class="mb-4 border-b border-gray-200 px-2">
              <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button @click="activeTab = 'list'" :class="[activeTab === 'list' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300', 'whitespace-nowrap py-2 border-b-2 font-medium text-sm']">Recorded Trees ({{ trees.length }})</button>
                <button @click="activeTab = 'table'" :class="[activeTab === 'table' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300', 'whitespace-nowrap py-2 border-b-2 font-medium text-sm']">Tree Table</button>
                <button @click="activeTab = 'map'" :class="[activeTab === 'map' ? 'border-teal-500 text-teal-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300', 'whitespace-nowrap py-2 border-b-2 font-medium text-sm']">Tree Map</button>
              </nav>
            </div>

            <!-- Tree Map Tab Content -->
            <div v-show="activeTab === 'map'" class="bg-white p-1">
              <!--<h2 class="text-xl font-semibold mb-2">Visual Tree Entry</h2>-->
              <p class="text-sm text-gray-500 mb-2">Tap on the canvas below to add a tree visually. A new tree will be created and can be edited in the 'Recorded Trees' tab.</p>
              <canvas ref="plotCanvas" class="plot-canvas w-full" @click="handleCanvasClick"></canvas>
            </div>

            <!-- Recorded Trees Tab Content -->
            <div v-if="activeTab === 'list'" class="bg-white p-1">
              <!--<h2 class="text-xl font-semibold mb-2 mt-4">Recorded Trees</h2>-->
              <ul class="space-y-1 max-h-[60vh] overflow-y-auto mb-1">
                <li v-if="trees.length === 0" class="text-center text-gray-500 py-8">No trees recorded for this plot yet.</li>
                <li v-for="tree in sortedTrees" :key="tree.id" class="bg-gray-50 border border-gray-200">
                  <div @click="selectTreeForEditing(tree)" class="p-1 cursor-pointer flex justify-between items-center" :class="editingTreeId === tree.id ? 'bg-lime-200' : 'hover:bg-gray-100'">
                    <div><p class="font-bold">{{ tree.treeNumber }}) {{ tree.design_code || '--'}} - {{ tree.species || 'N/A' }} - {{ tree.diameter || 'N/A' }} in - {{ tree.status || 'N/A' }}</p></div>
                    <div class="flex items-center space-x-2">
                      <i :class="editingTreeId === tree.id ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" class="h-5 w-5 text-gray-500"></i>
                    </div>
                  </div>
                  <TreeEditForm
                    v-if="editingTreeId === tree.id"
                    :tree="tree"
                    :design_code_list="design_code_list"
                    :status_list="status_list"
                    :species_list="species_list"
                    :bole_diam_codes="bole_diam_codes"
                    :crown_position_list="crown_position_list"
                    :crown_ratio_list="crown_ratio_list"
                    :vigor_list="vigor_list"
                    :damage_list="damage_list"
                    @delete="handleDeleteTree"
                    @save="handleSaveTree"
                    @cancel="editingTreeId = null"
                  />
                </li>
              </ul>

              <!-- New Tree Form -->
              <!-- TODO: Use the TreeEditForm component for consistency -->
              <div class="bg-lime-100 mb-1 p-2 border border-gray-200">
                <h2 class="text-xl font-semibold mb-2">Add Tree</h2>
                <form @submit.prevent="addTreeByAzimuth" class="grid grid-cols-3 md:grid-cols-7 lg:grid-cols-11 gap-2 items-end mt-2 mr-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Sample Code</label>
                    <select v-model="treeAddForm.design_code" class="input-field w-20" required>
                      <option disabled value="">Select</option>
                      <option v-for="code in design_code_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Species</label>
                    <select v-model="treeAddForm.species" class="input-field w-20" required>
                      <option disabled value="">Select</option>
                      <option v-for="code in species_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <select v-model="treeAddForm.status" class="input-field w-20" required>
                      <option disabled value="">Select</option>
                      <option v-for="code in status_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Count</label>
                    <input v-model="treeAddForm.count" type="number" class="input-field w-20" required>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">DBH (in)</label>
                    <input v-model.number="treeAddForm.dbh" type="number" step="0.1" class="input-field w-20" required>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Form Point</label>
                    <input v-model.number="treeAddForm.form_point" type="number" step="0.1" class="input-field w-20" required>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Form Factor</label>
                    <input v-model.number="treeAddForm.form_factor" type="number" step="0.1" placeholder="e.g., 85.2" class="input-field w-20">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Bole Diam</label>
                    <select v-model="treeAddForm.bole_diam" class="input-field w-20">
                      <option v-for="code in bole_diam_codes" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Bole Ht.</label>
                    <input v-model.number="treeAddForm.bole_height" type="number" step="0.1" placeholder="e.g., 99" class="input-field w-20">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Total Ht.</label>
                    <input v-model.number="treeAddForm.total_height" type="number" step="0.1" placeholder="e.g., 120.5" class="input-field w-20">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Age</label>
                    <input v-model.number="treeAddForm.bh_age" type="number" step="1.0" placeholder="e.g., 42" class="input-field w-20">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Crown Pos.</label>
                    <select v-model="treeAddForm.crown_position" class="input-field w-20">
                      <option v-for="code in crown_position_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Crown Ratio</label>
                    <select v-model="treeAddForm.crown_ratio" class="input-field w-20">
                      <option v-for="code in crown_ratio_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Vigor</label>
                    <select v-model="treeAddForm.vigor" class="input-field w-20">
                      <option v-for="code in vigor_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Damage</label>
                    <select v-model="treeAddForm.damage" class="input-field w-20">
                      <option v-for="code in damage_list" :key="code" :value="code">{{ code }}</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Azimuth (°)</label>
                    <input v-model.number="treeAddForm.azimuth" type="number" step="0.1" class="input-field w-20" required>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700">Distance (ft)</label>
                    <input v-model.number="treeAddForm.distance" type="number" step="0.1" class="input-field w-20" required>
                  </div>
                  <div class="col-span-full">
                    <label class="block text-sm font-medium text-gray-700">Notes</label>
                    <textarea v-model="treeAddForm.notes" placeholder="Any additional notes..." class="input-field w-full" rows="1"></textarea>
                  </div>
                  <!--<button type="submit" class="btn btn-secondary">
                    <i class="pi pi-plus h-5 w-5 mr-2"></i> Add
                  </button>-->
                  <div class="pt-2 flex justify-end">
                    <button type="submit" class="btn btn-primary">
                      <i class="pi pi-save h-5 w-5 mr-2"></i> Save
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Tree Table Tab Content -->
            <div v-if="activeTab === 'table'" class="bg-white">
                <TreeTable
                  :trees="sortedTrees"
                  :design_code_list="design_code_list"
                  :status_list="status_list"
                  :species_list="species_list"
                  :bole_diam_codes="bole_diam_codes"
                  :crown_position_list="crown_position_list"
                  :crown_ratio_list="crown_ratio_list"
                  :vigor_list="vigor_list"
                  :damage_list="damage_list"
                  @create-tree="handleCreateTable"
                  @update-tree="handleSaveTree"
                  @delete-tree="handleDeleteTree"
                />
            </div>

          </div>
          <div v-else class="text-center text-gray-500 py-8">Loading plot data...</div>
        </div>
      `,
      setup() {
        const route = useRoute(); // Access current route information
        const plotId = route.params.plotId; // Get plotId from route params
        const plot = ref({}); // Reactive reference for the current plot
        const trees = ref([]); // Reactive reference for trees in the plot
        const plotCanvas = ref(null); // Reactive reference for the canvas element
        const editingTreeId = ref(null); // Reactive reference to track which tree is being edited
        const confirmInfo = reactive({ show: false, treeId: null }); // Reactive object for confirmation modal state
        const activeTab = ref('list'); // Reactive reference for the active tab ('map' or 'list' or 'table')

        // Inject the globally provided showAbout function
        const showAbout = inject('showAbout');

        // Constants for canvas drawing
        const CANVAS_SIZE = 500;
        const PLOT_CENTER_RADIUS = 8;
        const TREE_RADIUS = 5;
        const METERS_TO_PIXELS_SCALE = 10; // 1 meter = 10 pixels on canvas

        // Computed property to determine the next available tree number
        const nextTreeNumber = computed(() => trees.value.length === 0 ? 1 : Math.max(...trees.value.map(t => t.treeNumber)) + 1);

        // Get the previous tree record for default values
        const previousTree = computed(() => {
          return trees.value.length > 0 ? trees.value[trees.value.length - 1] : { form_point: { value: 0 } };
        });

        // treeAddForm gets default values from previousTree if available
        const treeAddForm = reactive({
          distance: null,
          azimuth: null,
          design_code: '',
          status: '',
          species: '',
          count: 1,
          diameter: null,
          bole_diam: '',
          form_point: 4
        });

        // When switching to the list tab or after adding/deleting, reset treeAddForm to new defaults
        function resettreeAddForm() {
          treeAddForm.distance = null;
          treeAddForm.azimuth = null;
          treeAddForm.design_code = previousTree.value.design_code || '';
          treeAddForm.status = previousTree.value.status || 'Live';
          treeAddForm.species = previousTree.value.species || '';
          treeAddForm.count = 1;
          treeAddForm.diameter = null;
          // treeAddForm.bole_diam = previousTree.value.bole_diam || '';
          treeAddForm.form_point = previousTree.value.form_point || 4;
        }
        watch([activeTab, trees], () => {
          if (activeTab.value === 'list') resettreeAddForm();
        }, { immediate: true });

        // Computed property for sorted trees (by treeNumber)
        const sortedTrees = computed(() => [...trees.value].sort((a, b) => a.treeNumber - b.treeNumber));

        // Function to load plot and tree data from IndexedDB
        async function loadData() {
          plot.value = await db.plots.get(plotId) || {};
          trees.value = await db.trees.where('plotId').equals(plotId).toArray();
          // If on the map tab, ensure canvas is drawn after data loads
          if (activeTab.value === 'map') {
            await nextTick(); // Wait for DOM update
            drawCanvas();
          }
        }

        // Set canvas dimensions and load data when component is mounted
        onMounted(() => {
          if (plotCanvas.value) {
            plotCanvas.value.width = CANVAS_SIZE;
            plotCanvas.value.height = CANVAS_SIZE;
          }
          loadData();
        });

        // Function to draw the plot and trees on the canvas
        function drawCanvas() {
          const canvas = plotCanvas.value;
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          const centerX = canvas.width / 2;
          const centerY = canvas.height / 2;

          ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas

          // Draw plot center
          ctx.beginPath();
          ctx.arc(centerX, centerY, PLOT_CENTER_RADIUS, 0, 2 * Math.PI);
          ctx.fillStyle = 'rgba(20, 83, 45, 0.8)'; // Dark green
          ctx.fill();
          ctx.lineWidth = 2;
          ctx.strokeStyle = '#14532d'; // Darker green border
          ctx.stroke();

          // Draw each tree
          trees.value.forEach(tree => {
            ctx.beginPath();
            ctx.arc(tree.x, tree.y, TREE_RADIUS, 0, 2 * Math.PI);
            if (editingTreeId.value === tree.id) {
              ctx.fillStyle = '#ccfbf1'; // Light teal for editing tree
              ctx.lineWidth = 2;
              ctx.strokeStyle = '#0d9488'; // Dark teal border
            } else {
              ctx.fillStyle = '#f97316'; // Orange for other trees
              ctx.lineWidth = 1;
              ctx.strokeStyle = '#ea580c'; // Darker orange border
            }
            ctx.fill();
            ctx.stroke();
          });
        }

        // Watch for changes in trees or editingTreeId to redraw the canvas
        watch([trees, editingTreeId], () => {
          if (activeTab.value === 'map') drawCanvas();
        }, { deep: true }); // Deep watch for changes within tree objects

        // Watch for tab changes to ensure canvas is redrawn when switching to 'map'
        watch(activeTab, (newTab) => {
          if (newTab === 'map') {
            nextTick(() => {
              if (plotCanvas.value) {
                plotCanvas.value.width = CANVAS_SIZE;
                plotCanvas.value.height = CANVAS_SIZE;
                drawCanvas();
              }
            });
          }
        });

        // Function to create a new tree record
        async function createNewTree(treeDetails) {
          const newTree = {
            id: uuid(),
            plotId: plotId,
            treeNumber: nextTreeNumber.value,
            count: 1,
            notes: '',
            createdAt: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            updatedBy: currentUser.username,
            // ...treeDetails
            bole_diam: previousTree.bole_diam || null
          };
          const id = await db.trees.add(newTree);
          await loadData();
          return id;
        }

        async function handleCreateTable(treeData) {
            delete treeData.id; // Remove placeholder id
            const newId = await createNewTree(treeData);
            // No need to switch tabs or set editing id from here
        }

        // Handle click events on the canvas
        function handleCanvasClick(event) {
          const rect = plotCanvas.value.getBoundingClientRect();
          // Calculate click coordinates relative to canvas
          const scaleX = plotCanvas.value.width / rect.width;
          const scaleY = plotCanvas.value.height / rect.height;
          const x = (event.clientX - rect.left) * scaleX;
          const y = (event.clientY - rect.top) * scaleY;

          // Check if an existing tree was clicked
          const clickedTree = trees.value.find(tree => Math.sqrt(Math.pow(tree.x - x, 2) + Math.pow(tree.y - y, 2)) < TREE_RADIUS * 2);

          if (clickedTree) {
            activeTab.value = 'list'; // Switch to list view
            editingTreeId.value = clickedTree.id; // Open the clicked tree for editing
          } else {
            // If no tree clicked, create a new one at the clicked location
            const centerX = plotCanvas.value.width / 2;
            const centerY = plotCanvas.value.height / 2;
            const dx = x - centerX;
            const dy = centerY - y; // y-axis is inverted in canvas (positive downwards)

            // Calculate distance from plot center
            const distance = Math.round((Math.sqrt(dx * dx + dy * dy) / METERS_TO_PIXELS_SCALE) * 10) / 10; // Convert pixels to meters

            // Calculate azimuth (angle from north, clockwise)
            let azimuth = (450 - (Math.atan2(dy, dx) * 180 / Math.PI)) % 360;
            azimuth = Math.round(azimuth * 10) / 10;

            createNewTree({
                x, y, azimuth, distance,
                species: previousTree.value.species || '',
                status: 'Live',
                diameter: null,
                design_code: previousTree.value.design_code || '',
                form_point: previousTree.value.form_point || 0,
                bole_diam: previousTree.value.bole_diam || ''
            }).then(newId => {
                activeTab.value = 'list';
                nextTick(() => {
                    editingTreeId.value = newId;
                });
            });
          }
        }

        // Function to toggle tree editing mode
        function selectTreeForEditing(tree) {
          editingTreeId.value = editingTreeId.value === tree.id ? null : tree.id;
        }

        // Handle saving updated tree data from TreeEditForm
        async function handleSaveTree(treeData) {
          // If azimuth/distance are provided, recalculate x/y coordinates for canvas
          let { azimuth, distance } = treeData;
          if (typeof azimuth === 'number' && typeof distance === 'number') {
            const centerX = CANVAS_SIZE / 2;
            const centerY = CANVAS_SIZE / 2;
            const angleRad = ((450 - azimuth) % 360) * Math.PI / 180; // Convert azimuth to radians (adjusted for canvas Y-axis)
            const scaledDistance = distance * METERS_TO_PIXELS_SCALE; // Convert meters to pixels
            treeData.x = centerX + scaledDistance * Math.cos(angleRad);
            treeData.y = centerY - scaledDistance * Math.sin(angleRad);
          }
          // Prepare data for saving, including update timestamp and user
          const dataToSave = { ...treeData, lastUpdated: new Date().toISOString(), updatedBy: currentUser.username };
          await db.trees.update(treeData.id, dataToSave); // Update in IndexedDB
          editingTreeId.value = null; // Close editing form
          await loadData(); // Reload data to update list and canvas
        }

        // Function to handle tree deletion
        async function handleDeleteTree(treeId) {
          if (editingTreeId.value === treeId) {
            editingTreeId.value = null;
          }
          confirmInfo.treeId = treeId;
          confirmInfo.show = true;
        }

        // Function to handle tree deletion after confirmation
        async function handleDeleteConfirm() {
          const treeIdToDelete = confirmInfo.treeId;
          await db.trees.delete(treeIdToDelete); // Delete from IndexedDB
          if (editingTreeId.value === treeIdToDelete) {
            editingTreeId.value = null; // Close editing form if the deleted tree was being edited
          }
          confirmInfo.show = false; // Hide confirmation modal
          confirmInfo.treeId = null; // Clear treeId
          await loadData(); // Reload data to update the list and canvas
        }

        // Function to add a tree using azimuth and distance inputs
        function addTreeByAzimuth() {
          const { distance, azimuth, design_code, status, count, species, diameter, form_point } = treeAddForm;
          if (distance === null || azimuth === null || !design_code || !status || !species || diameter === null) return;

          const centerX = plotCanvas.value.width / 2;
          const centerY = plotCanvas.value.height / 2;
          const angleRad = (450 - azimuth) % 360 * Math.PI / 180; // Convert azimuth to radians
          const scaledDistance = distance * METERS_TO_PIXELS_SCALE; // Convert meters to pixels

          // Calculate canvas X and Y coordinates
          const x = centerX + scaledDistance * Math.cos(angleRad);
          const y = centerY - scaledDistance * Math.sin(angleRad);

          createNewTree({ x, y, azimuth, distance, design_code, status, species, diameter, form_point, count }).then(newId => {
              activeTab.value = 'list';
              nextTick(() => {
                  editingTreeId.value = newId;
              });
          });
          resettreeAddForm();
        }

        // Breadcrumbs for PlotObservation
        const project = ref({});
        onMounted(async () => {
          if (plot.value.projectId) {
            project.value = await db.projects.get(plot.value.projectId) || {};
          }
        });
        watch(() => plot.value.projectId, async (newProjectId) => {
          if (newProjectId) {
            project.value = await db.projects.get(newProjectId) || {};
          }
        });

        const breadcrumbs = computed(() => [
          { label: 'Projects', to: '/' },
          { label: project.value.name || 'Project', to: `/project/${plot.value.projectId}/plots` },
          { label: `Plot #${plot.value.plotNumber || ''}` }
        ]);

        function importProject(e) {
            console.log("Import triggered on PlotObservation page.");
        }

        return {
          plot, trees, design_code_list, status_list, species_list, bole_diam_codes,
          crown_position_list, crown_ratio_list, vigor_list, damage_list,
          sortedTrees, plotCanvas, handleCanvasClick, selectTreeForEditing, handleSaveTree, handleDeleteTree,
          nextTreeNumber, treeAddForm, addTreeByAzimuth, confirmInfo, handleDeleteConfirm, activeTab, editingTreeId,
          breadcrumbs, importProject, showAbout, handleCreateTable
        };
      }
    };

    // --- NEW: Root component to manage global state like the About modal ---
    const Root = {
        components: { About },
        setup() {
            const aboutInfo = reactive({
                show: false,
                app_version: '0.0.1',
                cache_version: '1.0.0'
            });

            function showAbout() {
                aboutInfo.show = true;
            }

            function hideAbout() {
                aboutInfo.show = false;
            }

            // Provide the showAbout function to all child components
            provide('showAbout', showAbout);

            return {
                aboutInfo,
                hideAbout
            };
        },
        template: `
            <div>
                <router-view></router-view>
                <About
                    v-if="aboutInfo.show"
                    :app_version="aboutInfo.app_version"
                    :cache_version="aboutInfo.cache_version"
                    @close="hideAbout"
                />
            </div>
        `
    };

    // --- VUE ROUTER SETUP ---
    // Define application routes
    const routes = [
      { path: '/', component: Home }, // Home page for project summary
      { path: '/project/:projectId/plots', component: PlotList }, // List of plots for a specific project
      { path: '/plot/:plotId', component: PlotObservation }, // Detailed observation for a single plot
    ];

    // Create the router instance
    const router = createRouter({
      history: createWebHashHistory(), // Use hash history for simple static file serving
      routes,
    });

    // --- VUE APP INITIALIZATION ---
    // Create the Vue application instance using the new Root component
    const app = createApp(Root);
    app.use(router);

    // Register router-link globally so it works in all templates
    app.component('router-link', VueRouter.RouterLink);

    // Mount the Vue application to the '#app' div
    app.mount('#app');

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator && window.location.protocol.startsWith('http')) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/mobile_cruise/service-worker.js').then(reg => {
          console.log('Service Worker registered successfully:', reg);
        }).catch(err => {
          console.error('Service Worker registration failed:', err);
        });
      });
    } else if ('serviceWorker' in navigator) {
       console.warn('Service Worker not registered. To enable offline PWA features, please serve this HTML file over a local server (http://localhost) or HTTPS.');
    }

  </script>
</body>
</html>
