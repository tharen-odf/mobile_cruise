<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Inventory PWA</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 and Vue Router -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>

    <!-- Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>

    <!-- Lucide Icons for a clean UI -->
    <script src="https://unpkg.com/lucide-vue-next"></script>

    <!-- Web App Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZvcmVzdCBJbnZlbnRvcnkgUFdBIiwKICAic2hvcnRfbmFtZSI6ICJGb3Jlc3RJeCIsCiAgImRlc2NyaXB0aW9uIjogIkFuIG9mZmxpbmUtZmlyc3QgUFdBIGZvciBjb2xsZWN0aW5nIGZvcmVzdCBpbnZlbnRvcnkgZGF0YS4iLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzI1NjM1Yi8zMTM2M2Y/dGV4dD1Gb3Jlc3RJeCIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzI1NjM1Yi8zMTM2M2Y/dGV4dD1Gb3Jlc3RJeCIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjM1YiIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZmFmYyIKfQ==">
    <meta name="theme-color" content="#25635b">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom styles for canvas and UI elements */
        .plot-canvas {
            border: 2px solid #d1d5db; /* gray-300 */
            background-color: #f9fafb; /* gray-50 */
            cursor: crosshair;
            touch-action: none; /* Prevents scrolling on canvas touch */
        }
        .btn {
            @apply inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-teal-600 hover:bg-teal-700 focus:ring-teal-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .input-field {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm;
        }
        .card {
            @apply bg-white shadow-lg rounded-lg p-4 sm:p-6 mb-4 transition-transform hover:scale-105;
        }
        .modal-container {
            @apply fixed inset-0 z-50 w-screen overflow-y-auto bg-gray-900 bg-opacity-75 transition-opacity;
        }
        .modal-panel {
            @apply relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4">
        <!-- The Vue Router will mount the active component here -->
    </div>

    <script type="module">
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;
        const { createRouter, createWebHashHistory, useRoute, useRouter } = VueRouter;
        const { LucideVueNext } = window;

        // --- DATABASE SETUP (Dexie.js) ---
        const db = new Dexie('ForestInventoryDB');
        db.version(1).stores({
            projects: '++id, name',
            plots: '++id, projectId, plotNumber',
            trees: '++id, plotId, treeNumber',
        });

        // --- MOCK USER ---
        const currentUser = { username: 'field_user_01' };

        // --- COMPONENT: Alert Modal ---
        const AlertModal = {
            props: ['title', 'message'],
            emits: ['close'],
            template: `
                <div class="modal-container" @click.self="$emit('close')">
                    <div class="flex min-h-full items-center justify-center p-4 text-center">
                        <div class="modal-panel w-full max-w-sm">
                            <div class="p-6 text-center">
                                <h3 class="text-lg font-semibold text-gray-900">{{ title }}</h3>
                                <p class="mt-2 text-sm text-gray-500">{{ message }}</p>
                                <div class="mt-4">
                                    <button type="button" @click="$emit('close')" class="btn btn-primary">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `
        };

        // --- COMPONENT: Confirmation Modal ---
        const ConfirmationModal = {
            props: ['title', 'message'],
            emits: ['confirm', 'cancel'],
            template: `
                <div class="modal-container" @click.self="$emit('cancel')">
                    <div class="flex min-h-full items-center justify-center p-4 text-center">
                        <div class="modal-panel w-full max-w-md">
                            <div class="p-6">
                                <div class="sm:flex sm:items-start">
                                    <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                                        <component :is="icons.AlertTriangle" class="h-6 w-6 text-red-600" aria-hidden="true" />
                                    </div>
                                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                        <h3 class="text-lg font-semibold leading-6 text-gray-900">{{ title }}</h3>
                                        <div class="mt-2">
                                            <p class="text-sm text-gray-500">{{ message }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                    <button type="button" @click="$emit('confirm')" class="btn btn-danger w-full sm:ml-3 sm:w-auto">Confirm</button>
                                    <button type="button" @click="$emit('cancel')" class="btn btn-secondary mt-3 w-full sm:mt-0 sm:w-auto">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const icons = { AlertTriangle: 'AlertTriangle' };
                return { icons };
            }
        };

        // --- COMPONENT: Home / Project Summary ---
        const Home = {
            components: { AlertModal },
            template: `
                <div class="space-y-6">
                    <AlertModal v-if="alertInfo.show" :title="alertInfo.title" :message="alertInfo.message" @close="alertInfo.show = false" />
                    <header class="flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-teal-800">Projects</h1>
                        <div class="flex items-center space-x-2">
                            <label for="import-json" class="btn btn-secondary cursor-pointer">
                                <component :is="icons.Upload" class="h-5 w-5 mr-2"/> Import
                            </label>
                            <input id="import-json" type="file" @change="importProject" class="hidden" accept=".json">
                        </div>
                    </header>

                    <div class="bg-white p-4 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-2">Create New Project</h2>
                        <form @submit.prevent="addProject" class="flex flex-col sm:flex-row gap-2">
                            <input v-model="newProjectName" type="text" placeholder="Enter project name" class="input-field flex-grow" required>
                            <button type="submit" class="btn btn-primary">
                                <component :is="icons.Plus" class="h-5 w-5 mr-2"/> Create Project
                            </button>
                        </form>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-2">Existing Projects</h2>
                        <div v-if="projects.length === 0" class="text-center text-gray-500 py-8">
                            No projects found. Create one to get started!
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="project in projects" :key="project.id" class="card">
                                <div class="flex-grow">
                                    <h3 class="text-lg font-bold text-teal-700">{{ project.name }}</h3>
                                    <p class="text-sm text-gray-500">Created: {{ new Date(project.createdAt).toLocaleString() }}</p>
                                    <p class="text-sm text-gray-500">Plots: {{ project.plotCount || 0 }}</p>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    <router-link :to="'/project/' + project.id + '/plots'" class="btn btn-primary text-sm flex-grow">
                                        <component :is="icons.Eye" class="h-4 w-4 mr-2"/> View Plots
                                    </router-link>
                                    <button @click="exportProject(project.id)" class="btn btn-secondary text-sm flex-grow">
                                        <component :is="icons.Download" class="h-4 w-4 mr-2"/> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const projects = ref([]);
                const newProjectName = ref('');
                const icons = { Plus: 'Plus', Upload: 'Upload', Download: 'Download', Eye: 'Eye' };
                const alertInfo = reactive({ show: false, title: '', message: '' });

                function showAlert(title, message) {
                    alertInfo.title = title;
                    alertInfo.message = message;
                    alertInfo.show = true;
                }

                async function loadProjects() {
                    const allProjects = await db.projects.toArray();
                    for (const proj of allProjects) {
                        proj.plotCount = await db.plots.where('projectId').equals(proj.id).count();
                    }
                    projects.value = allProjects;
                }

                onMounted(loadProjects);

                async function addProject() {
                    if (!newProjectName.value.trim()) return;
                    await db.projects.add({
                        name: newProjectName.value,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        updatedBy: currentUser.username,
                    });
                    newProjectName.value = '';
                    await loadProjects();
                }

                async function exportProject(projectId) {
                    const project = await db.projects.get(projectId);
                    const plots = await db.plots.where('projectId').equals(projectId).toArray();
                    const trees = await db.trees.where('plotId').anyOf(plots.map(p => p.id)).toArray();

                    const exportData = { project, plots, trees };
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${project.name.replace(/\s+/g, '_')}_export.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                }

                function importProject(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (!data.project || !data.plots || !data.trees) {
                                showAlert('Import Error', 'Invalid project file format.');
                                return;
                            }

                            await db.transaction('rw', db.projects, db.plots, db.trees, async () => {
                                delete data.project.id;
                                const newProjectId = await db.projects.add(data.project);

                                for(const plot of data.plots) {
                                    const oldPlotId = plot.id;
                                    delete plot.id;
                                    plot.projectId = newProjectId;
                                    const newPlotId = await db.plots.add(plot);

                                    const relatedTrees = data.trees.filter(t => t.plotId === oldPlotId);
                                    for(const tree of relatedTrees) {
                                        delete tree.id;
                                        tree.plotId = newPlotId;
                                    }
                                    if(relatedTrees.length > 0) {
                                        await db.trees.bulkAdd(relatedTrees);
                                    }
                                }
                            });
                            showAlert('Success', 'Project imported successfully!');
                            await loadProjects();
                        } catch (error) {
                            console.error('Import failed:', error);
                            showAlert('Import Failed', 'Could not import project. Check console for details.');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                }

                return { projects, newProjectName, addProject, exportProject, importProject, icons, alertInfo };
            }
        };

        // --- COMPONENT: PlotList ---
        const PlotList = {
            components: { ConfirmationModal },
            template: `
                <div>
                    <ConfirmationModal v-if="confirmInfo.show"
                        title="Delete Plot"
                        message="Are you sure you want to delete this plot and all its associated trees? This action cannot be undone."
                        @confirm="handleDeleteConfirm"
                        @cancel="confirmInfo.show = false"
                    />
                    <header class="mb-4">
                        <router-link to="/" class="text-teal-600 hover:underline flex items-center">
                           <component :is="icons.ArrowLeft" class="h-4 w-4 mr-1"/> Back to Projects
                        </router-link>
                        <h1 class="text-3xl font-bold text-teal-800 mt-2">{{ project.name }}</h1>
                    </header>

                     <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold mb-2">Add New Plot</h2>
                        <form @submit.prevent="addPlot" class="flex flex-col sm:flex-row gap-2">
                            <input v-model.number="newPlotNumber" type="number" placeholder="Enter plot number" class="input-field flex-grow" required>
                            <button type="submit" class="btn btn-primary">
                                <component :is="icons.Plus" class="h-5 w-5 mr-2"/> Add Plot
                            </button>
                        </form>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-2">Survey Plots</h2>
                         <div v-if="plots.length === 0" class="text-center text-gray-500 py-8">
                            No plots found for this project. Add one to begin.
                        </div>
                        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="plot in plots" :key="plot.id" class="card">
                                <h3 class="text-lg font-bold text-teal-700">Plot #{{ plot.plotNumber }}</h3>
                                <p class="text-sm text-gray-500">Trees Recorded: {{ plot.treeCount || 0 }}</p>
                                <p class="text-sm text-gray-500">Last Updated: {{ new Date(plot.lastUpdated).toLocaleString() }}</p>
                                <div class="mt-4 flex gap-2">
                                    <router-link :to="'/plot/' + plot.id" class="btn btn-primary text-sm flex-grow">
                                        <component :is="icons.ClipboardList" class="h-4 w-4 mr-2"/> Enter Data
                                    </router-link>
                                    <button @click="deletePlot(plot.id)" class="btn btn-danger text-sm">
                                        <component :is="icons.Trash2" class="h-4 w-4"/>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            setup() {
                const route = useRoute();
                const router = useRouter();
                const projectId = Number(route.params.projectId);
                const project = ref({});
                const plots = ref([]);
                const newPlotNumber = ref(null);
                const icons = { Plus: 'Plus', ArrowLeft: 'ArrowLeft', ClipboardList: 'ClipboardList', Trash2: 'Trash2' };
                const confirmInfo = reactive({ show: false, plotId: null });

                async function loadData() {
                    const proj = await db.projects.get(projectId);
                    if (!proj) {
                        router.push('/');
                        return;
                    }
                    project.value = proj;

                    const allPlots = await db.plots.where('projectId').equals(projectId).sortBy('plotNumber');
                    for (const plot of allPlots) {
                        plot.treeCount = await db.trees.where('plotId').equals(plot.id).count();
                    }
                    plots.value = allPlots;
                }

                onMounted(loadData);

                async function addPlot() {
                    if (newPlotNumber.value === null) return;
                    await db.plots.add({
                        projectId: projectId,
                        plotNumber: newPlotNumber.value,
                        slope: 0, aspect: 0, elevation: 0,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        updatedBy: currentUser.username,
                    });
                    newPlotNumber.value = null;
                    await loadData();
                }

                function deletePlot(plotId) {
                    confirmInfo.plotId = plotId;
                    confirmInfo.show = true;
                }

                async function handleDeleteConfirm() {
                    await db.transaction('rw', db.plots, db.trees, async () => {
                        await db.trees.where('plotId').equals(confirmInfo.plotId).delete();
                        await db.plots.delete(confirmInfo.plotId);
                    });
                    confirmInfo.show = false;
                    confirmInfo.plotId = null;
                    await loadData();
                }

                return { project, plots, newPlotNumber, addPlot, deletePlot, icons, confirmInfo, handleDeleteConfirm };
            }
        };

        // --- COMPONENT: Tree Form Modal ---
        const TreeForm = {
            props: ['tree', 'plotId', 'nextTreeNumber'],
            emits: ['close', 'save'],
            template: `
                <div class="modal-container" @click.self="$emit('close')">
                    <div class="flex min-h-full items-center justify-center p-4 text-center">
                        <div class="modal-panel w-full max-w-md">
                            <form @submit.prevent="saveTree" class="p-6 space-y-4">
                                <h3 class="text-xl font-bold text-teal-800">Tree #{{ localTree.treeNumber }} Details</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Species</label>
                                        <input v-model="localTree.species" type="text" placeholder="e.g., PSME" class="input-field" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Status</label>
                                        <select v-model="localTree.status" class="input-field">
                                            <option>Live</option>
                                            <option>Dead</option>
                                            <option>Cut</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Diameter (cm)</label>
                                        <input v-model.number="localTree.diameter" type="number" step="0.1" placeholder="e.g., 45.2" class="input-field" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Height (m)</label>
                                        <input v-model.number="localTree.height" type="number" step="0.1" placeholder="e.g., 30.5" class="input-field">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Notes</label>
                                    <textarea v-model="localTree.notes" placeholder="Any additional notes..." class="input-field" rows="3"></textarea>
                                </div>
                                <div class="pt-4 flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-3">
                                    <button type="button" @click="$emit('close')" class="btn btn-secondary mt-2 sm:mt-0">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Tree</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `,
            setup(props, { emit }) {
                const localTree = reactive({ ...props.tree });
                if (!localTree.id) {
                    localTree.treeNumber = props.nextTreeNumber;
                    localTree.species = '';
                    localTree.status = 'Live';
                    localTree.diameter = null;
                    localTree.height = null;
                    localTree.notes = '';
                    localTree.plotId = props.plotId;
                }
                function saveTree() { emit('save', { ...localTree }); }
                return { localTree, saveTree };
            }
        };

        // --- COMPONENT: Plot Observation ---
        const PlotObservation = {
            components: { TreeForm, ConfirmationModal },
            template: `
                <div v-if="plot.id">
                    <ConfirmationModal v-if="confirmInfo.show"
                        title="Delete Tree"
                        message="Are you sure you want to delete this tree? This action cannot be undone."
                        @confirm="handleDeleteConfirm"
                        @cancel="confirmInfo.show = false"
                    />
                    <header class="mb-4">
                        <router-link :to="'/project/' + plot.projectId + '/plots'" class="text-teal-600 hover:underline flex items-center">
                            <component :is="icons.ArrowLeft" class="h-4 w-4 mr-1"/> Back to Plot List
                        </router-link>
                        <h1 class="text-3xl font-bold text-teal-800 mt-2">Plot #{{ plot.plotNumber }}</h1>
                    </header>

                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold mb-2">Plot Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">Slope (%)</label><input v-model.number="plot.slope" @change="savePlotDetails" type="number" class="input-field"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Aspect (°)</label><input v-model.number="plot.aspect" @change="savePlotDetails" type="number" class="input-field"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Elevation (m)</label><input v-model.number="plot.elevation" @change="savePlotDetails" type="number" class="input-field"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                            <h2 class="text-xl font-semibold mb-2">Tree Map</h2>
                            <p class="text-sm text-gray-500 mb-2">Tap on the canvas to add a tree, or tap an existing tree to edit.</p>
                            <canvas ref="plotCanvas" class="plot-canvas w-full rounded-md" @click="handleCanvasClick"></canvas>
                            <div class="mt-4 p-4 border border-gray-200 rounded-md">
                                <h3 class="font-semibold mb-2">Add Tree by Distance & Azimuth</h3>
                                <form @submit.prevent="addTreeByAzimuth" class="flex flex-col sm:flex-row gap-2 items-end">
                                    <div class="flex-grow"><label class="block text-sm font-medium text-gray-700">Distance (m)</label><input v-model.number="azimuthForm.distance" type="number" step="0.1" class="input-field" required></div>
                                    <div class="flex-grow"><label class="block text-sm font-medium text-gray-700">Azimuth (°)</label><input v-model.number="azimuthForm.azimuth" type="number" step="0.1" class="input-field" required></div>
                                    <button type="submit" class="btn btn-secondary w-full sm:w-auto"><component :is="icons.Plus" class="h-5 w-5 mr-2"/> Add</button>
                                </form>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow">
                            <h2 class="text-xl font-semibold mb-2">Recorded Trees ({{ trees.length }})</h2>
                            <ul class="space-y-2 max-h-96 overflow-y-auto">
                                <li v-for="tree in sortedTrees" :key="tree.id" @click="selectTree(tree)" class="p-3 rounded-md cursor-pointer flex justify-between items-center" :class="selectedTree?.id === tree.id ? 'bg-teal-100 ring-2 ring-teal-500' : 'bg-gray-50 hover:bg-gray-100'">
                                    <div><p class="font-bold">Tree #{{ tree.treeNumber }}</p><p class="text-sm text-gray-600">{{ tree.species || 'No species' }} - {{ tree.diameter || 'N/A' }}cm</p></div>
                                    <button @click.stop="deleteTree(tree.id)" class="text-red-500 hover:text-red-700 p-1 rounded-full"><component :is="icons.Trash2" class="h-4 w-4"/></button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <TreeForm v-if="isTreeFormOpen" :tree="selectedTree" :plotId="plot.id" :nextTreeNumber="nextTreeNumber" @close="isTreeFormOpen = false" @save="handleSaveTree"/>
                </div>
                <div v-else class="text-center text-gray-500 py-8">Loading plot data...</div>
            `,
            setup() {
                const route = useRoute();
                const plotId = Number(route.params.plotId);
                const plot = ref({});
                const trees = ref([]);
                const plotCanvas = ref(null);
                const selectedTree = ref(null);
                const isTreeFormOpen = ref(false);
                const icons = { ArrowLeft: 'ArrowLeft', Plus: 'Plus', Trash2: 'Trash2' };
                const azimuthForm = reactive({ distance: null, azimuth: null });
                const confirmInfo = reactive({ show: false, treeId: null });

                const CANVAS_SIZE = 500, PLOT_CENTER_RADIUS = 8, TREE_RADIUS = 5, METERS_TO_PIXELS_SCALE = 10;

                const nextTreeNumber = computed(() => trees.value.length === 0 ? 1 : Math.max(...trees.value.map(t => t.treeNumber)) + 1);
                const sortedTrees = computed(() => [...trees.value].sort((a, b) => a.treeNumber - b.treeNumber));

                async function loadData() {
                    plot.value = await db.plots.get(plotId) || {};
                    trees.value = await db.trees.where('plotId').equals(plotId).toArray();
                    drawCanvas();
                }

                onMounted(() => {
                    if (plotCanvas.value) {
                       plotCanvas.value.width = CANVAS_SIZE;
                       plotCanvas.value.height = CANVAS_SIZE;
                    }
                    loadData();
                });

                function drawCanvas() {
                    const canvas = plotCanvas.value;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const centerX = canvas.width / 2, centerY = canvas.height / 2;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, PLOT_CENTER_RADIUS, 0, 2 * Math.PI);
                    ctx.fillStyle = 'rgba(20, 83, 45, 0.8)'; ctx.fill();
                    ctx.lineWidth = 2; ctx.strokeStyle = '#14532d'; ctx.stroke();
                    trees.value.forEach(tree => {
                        ctx.beginPath();
                        ctx.arc(tree.x, tree.y, TREE_RADIUS, 0, 2 * Math.PI);
                        if (selectedTree.value && selectedTree.value.id === tree.id) {
                            ctx.fillStyle = '#ccfbf1'; ctx.fill();
                            ctx.lineWidth = 2; ctx.strokeStyle = '#0d9488';
                        } else {
                            ctx.fillStyle = '#f97316'; ctx.fill();
                            ctx.lineWidth = 1; ctx.strokeStyle = '#ea580c';
                        }
                        ctx.stroke();
                    });
                }

                watch([trees, selectedTree], drawCanvas, { deep: true });

                async function savePlotDetails() {
                    await db.plots.update(plotId, {
                        slope: plot.value.slope, aspect: plot.value.aspect, elevation: plot.value.elevation,
                        lastUpdated: new Date().toISOString(), updatedBy: currentUser.username,
                    });
                }

                function getTreeAt(x, y) {
                    return trees.value.find(tree => Math.sqrt(Math.pow(tree.x - x, 2) + Math.pow(tree.y - y, 2)) < TREE_RADIUS * 2);
                }

                function handleCanvasClick(event) {
                    const rect = plotCanvas.value.getBoundingClientRect();
                    const scaleX = plotCanvas.value.width / rect.width;
                    const scaleY = plotCanvas.value.height / rect.height;
                    const x = (event.clientX - rect.left) * scaleX;
                    const y = (event.clientY - rect.top) * scaleY;
                    const clickedTree = getTreeAt(x, y);
                    selectTree(clickedTree || { x, y }, !clickedTree);
                }

                function selectTree(tree, isNew = false) {
                    selectedTree.value = tree;
                    isTreeFormOpen.value = true;
                }

                async function handleSaveTree(treeData) {
                    const dataToSave = { ...treeData, lastUpdated: new Date().toISOString(), updatedBy: currentUser.username };
                    if (dataToSave.id) {
                        await db.trees.update(dataToSave.id, dataToSave);
                    } else {
                        dataToSave.createdAt = new Date().toISOString();
                        await db.trees.add(dataToSave);
                    }
                    isTreeFormOpen.value = false;
                    selectedTree.value = null;
                    await loadData();
                }

                function deleteTree(treeId) {
                    confirmInfo.treeId = treeId;
                    confirmInfo.show = true;
                }

                async function handleDeleteConfirm() {
                    const treeIdToDelete = confirmInfo.treeId;
                    await db.trees.delete(treeIdToDelete);
                    if (selectedTree.value?.id === treeIdToDelete) {
                        selectedTree.value = null;
                    }
                    confirmInfo.show = false;
                    confirmInfo.treeId = null;
                    await loadData();
                }

                function addTreeByAzimuth() {
                    const { distance, azimuth } = azimuthForm;
                    if (distance === null || azimuth === null) return;
                    const centerX = plotCanvas.value.width / 2, centerY = plotCanvas.value.height / 2;
                    const angleRad = (450 - azimuth) % 360 * Math.PI / 180;
                    const scaledDistance = distance * METERS_TO_PIXELS_SCALE;
                    const x = centerX + scaledDistance * Math.cos(angleRad);
                    const y = centerY - scaledDistance * Math.sin(angleRad);
                    selectTree({ x, y }, true);
                    azimuthForm.distance = null; azimuthForm.azimuth = null;
                }

                return {
                    plot, trees, sortedTrees, plotCanvas, savePlotDetails, handleCanvasClick,
                    selectedTree, isTreeFormOpen, selectTree, handleSaveTree, deleteTree,
                    nextTreeNumber, icons, azimuthForm, addTreeByAzimuth, confirmInfo, handleDeleteConfirm
                };
            }
        };

        // --- VUE ROUTER SETUP ---
        const routes = [
            { path: '/', component: Home },
            { path: '/project/:projectId/plots', component: PlotList },
            { path: '/plot/:plotId', component: PlotObservation },
        ];
        const router = createRouter({ history: createWebHashHistory(), routes });

        // --- VUE APP INITIALIZATION ---
        // The root component's template contains the <router-view> tag,
        // which is where the router will render the matched page component.
        const app = createApp({
            template: '<router-view></router-view>'
        });
        app.use(router);
        app.use(LucideVueNext);
        app.mount('#app');

        // --- PWA Service Worker ---
        // Service workers require the page to be served over HTTP/HTTPS and will not work on file:// URLs.
        if ('serviceWorker' in navigator && window.location.protocol.startsWith('http')) {
            const swContent = `
                const CACHE_NAME = 'forest-inventory-cache-v2';
                const URLS_TO_CACHE = [
                    './',
                    'https://cdn.tailwindcss.com/',
                    'https://unpkg.com/vue@3/dist/vue.global.js',
                    'https://unpkg.com/vue-router@4/dist/vue-router.global.js',
                    'https://unpkg.com/dexie@3/dist/dexie.js',
                    'https://unpkg.com/lucide-vue-next'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => cache.addAll(URLS_TO_CACHE))
                    );
                });

                self.addEventListener('fetch', event => {
                    if (event.request.method !== 'GET') return;
                    event.respondWith(
                        caches.match(event.request).then(cachedResponse => {
                            if (cachedResponse) {
                                return cachedResponse;
                            }
                            return fetch(event.request).then(networkResponse => {
                                if (networkResponse && networkResponse.status === 200) {
                                    const responseToCache = networkResponse.clone();
                                    caches.open(CACHE_NAME).then(cache => {
                                        cache.put(event.request, responseToCache);
                                    });
                                }
                                return networkResponse;
                            });
                        })
                    );
                });
            `;
            const swBlob = new Blob([swContent], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);

            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.error('ServiceWorker registration failed: ', err);
                    });
            });
        } else if ('serviceWorker' in navigator) {
             console.warn('Service Worker not registered. To enable offline PWA features, please serve this HTML file over a local server (http://localhost) instead of opening it directly as a file.');
        }
    </script>
</body>
</html>
